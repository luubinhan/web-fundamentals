



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Hàm async - Kiến thức nền tảng của Web</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#ham-async" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Kiến thức nền tảng của Web" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Kiến thức nền tảng của Web
            </span>
            <span class="md-header-nav__topic">
              
                Hàm async
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Kiến thức nền tảng của Web" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Kiến thức nền tảng của Web
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      UI/UX
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        UI/UX
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ui-ux/font/" title="Font chữ trên web" class="md-nav__link">
      Font chữ trên web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ui-ux/mot-website-tot-tren-mobile-la-nhu-the-nao/" title="Một website tốt trên mobile là như thế nào" class="md-nav__link">
      Một website tốt trên mobile là như thế nào
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ui-ux/focus/" title="Focus" class="md-nav__link">
      Focus
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ui-ux/dom-order/" title="DOM Order" class="md-nav__link">
      DOM Order
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ui-ux/su-dung-tab-index/" title="Tab Index" class="md-nav__link">
      Tab Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ui-ux/aria/" title="Aria" class="md-nav__link">
      Aria
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ui-ux/hiding-update-content/" title="Hiding update content" class="md-nav__link">
      Hiding update content
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ui-ux/responsive-pattern/" title="Layout responsive" class="md-nav__link">
      Layout responsive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ui-ux/responsive-image/" title="Responsive image" class="md-nav__link">
      Responsive image
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Tương tác
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Tương tác
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../interact/touch/" title="Thêm touch cho website" class="md-nav__link">
      Thêm touch cho website
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Security
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Security
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../security/content-security-policy/" title="Content Security Policy" class="md-nav__link">
      Content Security Policy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../security/tai-sao-can-https/" title="Tại sao cần HTTPs" class="md-nav__link">
      Tại sao cần HTTPs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../security/thuat-ngu-bao-mat-quan-trong/" title="Những thuật ngữ bảo mật quan trọng" class="md-nav__link">
      Những thuật ngữ bảo mật quan trọng
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../security/mixed-content-la-gi/" title="Mixed content là gì" class="md-nav__link">
      Mixed content là gì
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#gia-tri-tra-ve-cua-async" class="md-nav__link">
    Giá trị trả về của async
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#streaming-mot-response" class="md-nav__link">
    Streaming một response
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mot-so-cu-phap-viet-ham-async-khac" class="md-nav__link">
    Một số cú pháp viết hàm async khác
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#can-than" class="md-nav__link">
    Cẩn thận
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vi-du-ket-qua-fetch-theo-thu-tu" class="md-nav__link">
    Ví dụ, kết quả fetch theo thứ tự
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trinh-duyet-nao-ho-tro" class="md-nav__link">
    Trình duyệt nào hỗ trợ
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="ham-async">Hàm async</h1>
<p>Hàm <code>async</code> được hỗ trợ từ phiên bản Chrome 55, cho phép chúng ta viết code một cách tuần tự nhưng chạy bất tuần tự như Promise, không ảnh hưởng đến main thread.</p>
<div class="codehilite"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">myFirstAsyncFunction</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">fulfilledValue</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">promise</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">rejectedValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// …</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><em>Lưu ý: nếu chưa biết promise, bạn cần đọc và nắm rõ promise trước</em></p>
<p>Doạn code sử dung Promise để fetch một dữ liệu từ API</p>
<div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">logFetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">text</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;fetch failed&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>


<p>Viết lại hàm trên thành hàm <code>async</code></p>
<div class="codehilite"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">logFetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;fetch failed&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Số lượng dòng code không đổi, nhưng không còn <code>callback</code>, code dễ hình dung hơn, đặc biệt với những ai chưa nắm cách hoạt động của <code>Promise</code>.</p>
<h2 id="gia-tri-tra-ve-cua-async">Giá trị trả về của async</h2>
<p>Hàm <code>async</code> luôn trả về <code>Promise</code>, dù bên trong có <code>await</code> hay không.</p>
<p><code>Promise</code> này sẽ được <code>resolve</code> khi hàm có <code>return</code> hoặc <code>reject</code> khi hàm <code>throw</code> một error.</p>
<div class="codehilite"><pre><span></span><span class="c1">// đợi trong mili giây</span>
<span class="kd">function</span> <span class="nx">wait</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">r</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">ms</span><span class="p">));</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">hello</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">await</span> <span class="nx">wait</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="k">return</span> <span class="s1">&#39;world&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Gọi <code>hello()</code> trả về một promise, với giá trị <code>world</code>.</p>
<div class="codehilite"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">await</span> <span class="nx">wait</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>Gọi <code>foo()</code> trả về một <code>Promise</code> với <code>reject</code> bằng <code>Error('bar')</code></p>
<h2 id="streaming-mot-response">Streaming một response</h2>
<p>Lợi ích của hàm <code>async</code> thấy rõ hơn khi ứng dụng vào các tình huống phức tạp hơn. Ví dụ như chúng ta streaming một response, tính ra kích thước cuối cùng của toàn bộ streaming</p>
<div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">getResponseSize</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">reader</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">getReader</span><span class="p">();</span>
    <span class="kd">let</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">read</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">processResult</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="k">return</span> <span class="nx">total</span><span class="p">;</span>

      <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="nx">total</span> <span class="o">+=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Received chunk&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>

      <span class="k">return</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">read</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">processResult</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>


<p>Nếu bạn không biết closure như những lập trình viên <em>thông minh khác</em>, bạn sẽ khó để <em>nuốt</em> được đoạn code trên.</p>
<p>Viết lại với hàm <code>async</code></p>
<div class="codehilite"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">getResponseSize</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">reader</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">getReader</span><span class="p">();</span>
  <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">read</span><span class="p">();</span>
  <span class="kd">let</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="nx">total</span> <span class="o">+=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Received chunk&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="c1">// lấy kết quả tiếp theo</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">read</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">total</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Cảm giác là người <em>thông minh nhất quả đất</em> không còn khi viết bằng <code>async</code>, code quá trực quan ngay cả sinh viên mới ra trường cũng hiểu.</p>
<h2 id="mot-so-cu-phap-viet-ham-async-khac">Một số cú pháp viết hàm async khác</h2>
<p>Bạn đã biết cách khai báo <code>async function() {}</code>, từ khóa <code>async</code> còn được dùng bằng nhiều cách viết khác</p>
<p><strong>Arrow function</strong></p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">jsonPromises</span> <span class="o">=</span> <span class="nx">urls</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">async</span> <span class="nx">url</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>


<p><strong>Phương thức của object</strong></p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">storage</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">async</span> <span class="nx">getAvatar</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;avatars&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sb">`/avatars/</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">.jpg`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">storage</span><span class="p">.</span><span class="nx">getAvatar</span><span class="p">(</span><span class="s1">&#39;jaffathecake&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="err">…</span><span class="p">);</span>
</pre></div>


<p><strong>Phương thức của class</strong></p>
<div class="codehilite"><pre><span></span><span class="kr">class</span> <span class="nx">Storage</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cachePromise</span> <span class="o">=</span> <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;avatars&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">async</span> <span class="nx">getAvatar</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">cachePromise</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sb">`/avatars/</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">.jpg`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Storage</span><span class="p">();</span>
<span class="nx">storage</span><span class="p">.</span><span class="nx">getAvatar</span><span class="p">(</span><span class="s1">&#39;jaffathecake&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="err">…</span><span class="p">);</span>
</pre></div>


<h2 id="can-than">Cẩn thận</h2>
<p>Code bây giờ sẽ rất <strong>step-by-step</strong>, nhưng bạn có thể bỏ qua cơ hội chạy song song nhiều code cùng lúc</p>
<div class="codehilite"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">series</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">await</span> <span class="nx">wait</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span> <span class="c1">// đợi 500ms…</span>
  <span class="nx">await</span> <span class="nx">wait</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span> <span class="c1">// …đợi thêm 500ms.</span>
  <span class="k">return</span> <span class="s2">&quot;done!&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Đoạn code bên dưới sẽ đợi mất 500ms để chạy xong.</p>
<div class="codehilite"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">parallel</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">wait1</span> <span class="o">=</span> <span class="nx">wait</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span> <span class="c1">// Start a 500ms timer asynchronously…</span>
  <span class="kr">const</span> <span class="nx">wait2</span> <span class="o">=</span> <span class="nx">wait</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span> <span class="c1">// …meaning this timer happens in parallel.</span>
  <span class="nx">await</span> <span class="nx">wait1</span><span class="p">;</span> <span class="c1">// Wait 500ms for the first timer…</span>
  <span class="nx">await</span> <span class="nx">wait2</span><span class="p">;</span> <span class="c1">// …by which time this timer has already finished.</span>
  <span class="k">return</span> <span class="s2">&quot;done!&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h3 id="vi-du-ket-qua-fetch-theo-thu-tu">Ví dụ, kết quả fetch theo thứ tự</h3>
<p>Theo kiểu Promise</p>
<div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">logInOrder</span><span class="p">(</span><span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// fetch all the URLs</span>
  <span class="kr">const</span> <span class="nx">textPromises</span> <span class="o">=</span> <span class="nx">urls</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">url</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">());</span>
  <span class="p">});</span>

  <span class="c1">// log them in order</span>
  <span class="nx">textPromises</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">chain</span><span class="p">,</span> <span class="nx">textPromise</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">textPromise</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">text</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">text</span><span class="p">));</span>
  <span class="p">},</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>


<p>Chúng ta đang dùng <code>reduce</code> để nối một chuỗi các promise với nhau. Chúng ta quá thông minh rồi. Tuy code thông minh quá như vậy rất khó bảo trì.</p>
<p>Nếu bạn code lại bằng async, bạn sẽ nghĩ liền tới giải pháp</p>
<p>❌ Không khuyến khích</p>
<div class="codehilite"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">logInOrder</span><span class="p">(</span><span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">url</span> <span class="k">of</span> <span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>✅ Chuẩn</p>
<div class="codehilite"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">logInOrder</span><span class="p">(</span><span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// fetch all the URLs in parallel</span>
  <span class="kr">const</span> <span class="nx">textPromises</span> <span class="o">=</span> <span class="nx">urls</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">async</span> <span class="nx">url</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="c1">// log them in sequence</span>
  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">textPromise</span> <span class="k">of</span> <span class="nx">textPromises</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">await</span> <span class="nx">textPromise</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Tại sao chuẩn? Với cách một, mỗi câu fetch phải <strong>đợi cho xong</strong> thì cầu thứ tiếp theo mới chạy, với cách 2, chúng ta cho phép nó chạy đồng thời nhiều câu fetch.</p>
<h2 id="trinh-duyet-nao-ho-tro">Trình duyệt nào hỗ trợ</h2>
<p>Thời điểm năm 2019, bạn có thể sử dụng trên Chrome, Edge, Firefox và Safari</p>
<p>Bạn cần dùng Babel polyfill cho các trình duyệt cũ hơn.</p>
<p>Một khi tất cả trình duyệt đã hỗ trợ async, viết hết bằng async cho những hàm trả về promise, code sẽ bớt thông minh hơn, đồng thời còn đảm bảo hàm luôn trả về Promise</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>