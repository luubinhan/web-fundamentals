
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.4">
    
    
      
        <title>Content Security Policy - Kiến thức nền tảng của Web</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.f7f47774.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/hybrid.min.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#whitelist" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Kiến thức nền tảng của Web" class="md-header__button md-logo" aria-label="Kiến thức nền tảng của Web" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kiến thức nền tảng của Web
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Content Security Policy
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Kiến thức nền tảng của Web" class="md-nav__button md-logo" aria-label="Kiến thức nền tảng của Web" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Kiến thức nền tảng của Web
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../thuat-ngu/" class="md-nav__link">
        Thuật ngữ
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        UI/UX
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="UI/UX" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          UI/UX
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/font/" class="md-nav__link">
        Font chữ trên web
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/mot-website-tot-tren-mobile-la-nhu-the-nao/" class="md-nav__link">
        Một website tốt trên mobile là như thế nào
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/focus/" class="md-nav__link">
        Focus
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/dom-order/" class="md-nav__link">
        DOM Order
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/su-dung-tab-index/" class="md-nav__link">
        Tab Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/aria/" class="md-nav__link">
        Aria
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/seo/" class="md-nav__link">
        SEO
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/hiding-update-content/" class="md-nav__link">
        Hiding update content
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/responsive-pattern/" class="md-nav__link">
        Layout responsive
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/responsive-image/" class="md-nav__link">
        Responsive image
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/add-to-homescreen/" class="md-nav__link">
        Thêm nút Add to Homescreen
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ui-ux/install-pwa/" class="md-nav__link">
        Gợi ý cài đặt PWA
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Tương tác
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tương tác" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Tương tác
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../interact/touch/" class="md-nav__link">
        Thêm touch cho website
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../interact/form/" class="md-nav__link">
        Thiết kế form thật ngầu
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../interact/user-location/" class="md-nav__link">
        Lấy thông tin vị trí của user
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../interact/web-app-manifest/" class="md-nav__link">
        Web App Manifest
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../interact/mang-xa-hoi/" class="md-nav__link">
        Tương tác với mạng xã hội
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      <label class="md-nav__link" for="__nav_5">
        Security
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../thuat-ngu-bao-mat-quan-trong/" class="md-nav__link">
        Những thuật ngữ bảo mật quan trọng
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../phan-biet-same-site-same-origin/" class="md-nav__link">
        Phân biệt same site và same origin
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Content Security Policy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Content Security Policy
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#whitelist" class="md-nav__link">
    Whitelist
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inline-code-vo-cung-nguy-hiem" class="md-nav__link">
    Inline code vô cùng nguy hiểm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eval" class="md-nav__link">
    Eval
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#to-cao" class="md-nav__link">
    Tố cáo
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../bao-ve-xss-bang-content-security-policy/" class="md-nav__link">
        Phòng tránh XSS bằng CSP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../phong-tranh-dom-xss-voi-trusted-type/" class="md-nav__link">
        Phòng tránh XSS bằng Trusted Type
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../tai-sao-can-https/" class="md-nav__link">
        Tại sao cần HTTPs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../mixed-content-la-gi/" class="md-nav__link">
        Mixed content là gì
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../khi-nao-dung-https-o-localhost/" class="md-nav__link">
        Sử dụng HTTPS ở localhost
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Audit
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Audit" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Audit
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../audit/overview/" class="md-nav__link">
        Giới thiệu
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../audit/check-site-security/" class="md-nav__link">
        Kiểm tra bảo mật
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../audit/cong-cu-danh-gia/" class="md-nav__link">
        Công cụ đánh giá
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" type="checkbox" id="__nav_6_4" >
      
      <label class="md-nav__link" for="__nav_6_4">
        Kiểm tra tốc độ
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kiểm tra tốc độ" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          Kiểm tra tốc độ
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../audit/he-thong-danh-gia-lighthouse/" class="md-nav__link">
        Hệ thống đánh giá của Lighthouse
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../audit/first-contentful-paint/" class="md-nav__link">
        First Contentful Paint
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../audit/speed-index/" class="md-nav__link">
        Speed Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        Kỹ thuật nền tảng
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kỹ thuật nền tảng" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Kỹ thuật nền tảng
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../base/app-shell/" class="md-nav__link">
        Mô hình vỏ ứng dụng
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../base/async/" class="md-nav__link">
        Hàm async
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#whitelist" class="md-nav__link">
    Whitelist
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inline-code-vo-cung-nguy-hiem" class="md-nav__link">
    Inline code vô cùng nguy hiểm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eval" class="md-nav__link">
    Eval
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#to-cao" class="md-nav__link">
    Tố cáo
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Content Security Policy</h1>
                
                <p>Mô hình bảo mật của web luôn xoay quanh quy định <strong>same-origin</strong>, <em>đèn nhà ai nhà đó sáng</em>. Code từ trang <code>vuilaptrinh.com</code> không được phép lấy gì từ <code>google.com</code> nếu ko được cấp giấy xét nhà</p>
<p>Tấn công theo cách <strong>Cross-site scripting</strong> (XSS) để qua mặt câu hỏi <strong>nhà anh ở đâu thế</strong>, dùng một tên <em>nội gián</em> (một đoạn script) gài vào nhà đó, rồi tuồn thông tin nội bộ từ nhà này ra <em>thế giới</em>, một khi nội gián đã nằm trong nhà bạn, thì xem như game over.</p>
<p>Để giảm thiểu tối đa nguy cơ bị dính <em>nội gián</em> này, các trình duyệt <em>hiện đại</em> sử dụng một phương pháp khác <strong>same-origin</strong> gọi là Content Security Policy (<strong>CSP</strong>)</p>
<h2 id="whitelist">Whitelist</h2>
<p>Ví dụ nút like của Google, khi user click vào nút này code đặt ở nhà bạn, nhưng nó sẽ chạy đưa thông tin tới  <code>api.google.com</code>, câu hỏi là làm sao chúng ta có thể cho phép những đoạn code gửi thông tin tới <code>api.google.com</code> mà không cho tới trang <code>evil.com</code></p>
<p>Chúng ta cấp <em>giấy chứng nhận an toàn vệ sinh thực phẩm</em> <strong>CSP</strong> (trong HTTP Header), để báo với browser là: "Ê, mấy trang này là tao tin tưởng, mày có thể cho code chạy thoải mái"</p>
<div class="highlight"><pre><span></span><code>Content-Security-Policy: script-src &#39;self&#39; https://apis.google.com
</code></pre></div>
<p>Đoạn trên có nghĩa là chúng ta tin tưởng và cho phép thực thi những đoạn script từ nhà chúng ta, và từ nhà google</p>
<p><code>script-src</code> được gọi là <strong>directive</strong>, có thể hình dung nó như những biển báo giao thông ngoài đường, đây là đường một chiều, chỉ cho phép xe máy, cấm xe ba gác.</p>
<p>Nếu <em>kẻ xấu</em> muốn load và thực thi một đoạn script ở một nhà không ai quen biết, nó sẽ bị chặn lại ngay lập tức bởi trình duyệt.</p>
<p><img alt="Không cho chạy code ở trang không nằm trong whitelist" src="https://developers.google.com/web/fundamentals/security/csp/images/csp-error.png" /></p>
<p>Danh sách <strong>directive</strong> khá nhiều, đang được khai báo thêm, chi tiết có thể xem tại <a href="https://www.w3.org/TR/CSP3/">https://www.w3.org/TR/CSP3/</a></p>
<p><strong>Sử dụng thẻ meta để thiết đặt CSP</strong></p>
<p>CSP được khuyến khích cung cấp thông qua HTTP header, hoặc có thể thông qua thẻ <code>&lt;meta/&gt;</code> với thuộc tính <code>http-equiv</code></p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">meta</span>
<span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;Content-Security-Policy&quot;</span>
<span class="na">content</span><span class="o">=</span><span class="s">&quot;default-src https://cdn.example.net; child-src &#39;none&#39;; object-src &#39;none&#39;&quot;</span>
<span class="p">&gt;</span>
</code></pre></div>
<p>Không được phép dùng thẻ meta với các thuộc tính <code>frame-ancestors</code>, <code>report-uri</code>, <code>sandbox</code></p>
<h2 id="inline-code-vo-cung-nguy-hiem">Inline code vô cùng nguy hiểm</h2>
<p>CSP sử dụng một các khai báo trong whitelist để thông báo với trình duyệt <em>đâu là bạn, đâu là thù</em>, trong khi cơ chế <strong>same-origin</strong> ko giải quyết được con nội gián <strong>XSS</strong>. Ví dụ bên trong source code trả về có đoạn code <code>&lt;script&gt;sendMyDataToEvilDotCom();&lt;/script&gt;</code> trình duyệt không có cơ chế để phân biệt được bạn-thù ở đây.</p>
<p>Với CSP nó mặc định cấm hết các script inline như vậy. Ko chỉ những đoạn inline code bên trong thẻ <code>script</code>, bạn cũng phải bỏ hết những đoạn code <code>onclick</code></p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
  <span class="kd">function</span> <span class="nx">doAmazingThings</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;YOU AM AMAZING!&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="o">&lt;</span><span class="err">/script&gt;</span>
<span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onclick</span><span class="o">=</span><span class="s1">&#39;doAmazingThings();&#39;</span><span class="o">&gt;</span><span class="nx">Am</span> <span class="nx">I</span> <span class="nx">amazing</span><span class="o">?&lt;</span><span class="err">/button&gt;</span>
</code></pre></div>
<p>Thay thế nó bằng</p>
<p><div class="highlight"><pre><span></span><code><span class="c">&lt;!-- amazing.html --&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#39;amazing.js&#39;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;amazing&#39;</span><span class="p">&gt;</span>Am I amazing?<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// amazing.js</span>
<span class="kd">function</span> <span class="nx">doAmazingThings</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;YOU AM AMAZING!&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;amazing&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">doAmazingThings</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></p>
<p>Đoạn code bên dưới sẽ được <strong>CSP</strong> cấp giấy chứng nhận hành nghề, có thể hoạt động kinh doanh bình thường.</p>
<p>Sau khi bị càm ràm là có nhiều trường hợp buộc dùng inline code, <strong>CSP</strong> phiên bản 2 được đưa ra với bổ sung khả năng cho chạy inline code, nhưng phải thêm 2 bước</p>
<ol>
<li>Khai báo id cho đoạn code muốn chạy inline</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">script</span> <span class="na">nonce</span><span class="o">=</span><span class="s">&quot;EDNnf03nceIOfn39fn3e9h3sdfa&quot;</span><span class="p">&gt;</span>
  <span class="c1">// Some inline code I can&#39;t remove yet, but need to asap.</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>
<ol>
<li>Bổ sung id đó vào whitelist</li>
</ol>
<div class="highlight"><pre><span></span><code>Content-Security-Policy: script-src &#39;nonce-EDNnf03nceIOfn39fn3e9h3sdfa&#39;
</code></pre></div>
<h2 id="eval">Eval</h2>
<p>Ngay cả khi không thể inject script trực tiếp, bọn <em>ác ôn</em> còn có thể dụ dỗ ứng dụng của chúng ta convert một đoạn text (bị nhúng) thành javascript rồi chạy nó bằng <code>eval()</code>, <code>new Function()</code>, <code>setTimeout([string],...)</code> và <code>setInterval([string],...)</code>. CSP cũng block toàn bộ những dạng này.</p>
<p>Nó sẽ ảnh hướng cách chúng ta xây dựng ứng dụng:</p>
<ul>
<li>Trong ta phải parse JSON thông qua hàm <code>JSON.parse</code> và không dùng <code>eval()</code></li>
<li>Viết lại những hàm <code>setTimeout</code> hoặc <code>setInterval</code> bạn đang viết inline. Ví dụ</li>
</ul>
<p><em>viết thế này méo cho chạy đâu</em></p>
<div class="highlight"><pre><span></span><code><span class="nx">setTimeout</span><span class="p">(</span><span class="s2">&quot;document.querySelector(&#39;a&#39;).style.display = &#39;none&#39;;&quot;</span><span class="p">,</span> <span class="mf">10</span><span class="p">);</span>
</code></pre></div>
<p>viết bình thường thôi</p>
<div class="highlight"><pre><span></span><code><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="p">},</span> <span class="mf">10</span><span class="p">);</span>
</code></pre></div>
<h2 id="to-cao">Tố cáo</h2>
<p>Ngoài việc chặn không cho thực thi những hành vi nguy hiểm ở client, nếu phát hiện chúng ta hãy <em>tố cáo</em> nó lên server để xác định những thành viên của tổ chức áo đen này và cho luôn vào blacklist</p>
<p>Config CSP như thế này để nó tố cáo</p>
<div class="highlight"><pre><span></span><code>Content-Security-Policy: default-src &#39;self&#39;; ...; report-uri /my_amazing_csp_report_parser;
</code></pre></div>
<p>Kết quả report nó sẽ dạng như thế này</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;csp-report&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;document-uri&quot;</span><span class="p">:</span> <span class="s2">&quot;http://example.org/page.html&quot;</span><span class="p">,</span>
    <span class="nt">&quot;referrer&quot;</span><span class="p">:</span> <span class="s2">&quot;http://evil.example.com/&quot;</span><span class="p">,</span>
    <span class="nt">&quot;blocked-uri&quot;</span><span class="p">:</span> <span class="s2">&quot;http://evil.example.com/evil.js&quot;</span><span class="p">,</span>
    <span class="nt">&quot;violated-directive&quot;</span><span class="p">:</span> <span class="s2">&quot;script-src &#39;self&#39; https://apis.google.com&quot;</span><span class="p">,</span>
    <span class="nt">&quot;original-policy&quot;</span><span class="p">:</span> <span class="s2">&quot;script-src &#39;self&#39; https://apis.google.com; report-uri http://example.org/my_amazing_csp_report_parser&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Chứng chỉ hành nghề <strong>CSP</strong> 1 được sử dụng rộng rãi trong Chrome, Safari, Firefox, chưa hỗ trợ đầy đủ trong IE10. Những ông lớn hiện nay như Twitter và Facebook có đã áp dụng vào thực tiễn, đọc thêm <a href="https://blog.twitter.com/engineering/en_us/a/2011/improving-browser-security-with-csp.html">Case study của Twitter</a></p>
<p><a href="https://developers.google.com/web/fundamentals/security/csp">https://developers.google.com/web/fundamentals/security/csp</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../phan-biet-same-site-same-origin/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Phân biệt same site và same origin" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Phân biệt same site và same origin
            </div>
          </div>
        </a>
      
      
        
        <a href="../bao-ve-xss-bang-content-security-policy/" class="md-footer__link md-footer__link--next" aria-label="Next: Phòng tránh XSS bằng CSP" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Phòng tránh XSS bằng CSP
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.709b4209.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.febc23d1.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
      
    
  </body>
</html>